<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声優報酬 計算アプリ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Word(.docx)ファイル読み込み用: mammoth.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Excel出力用: xlsx.js (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 日本語フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-10">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg mx-4">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">声優報酬 計算アプリ</h1>
        
        <!-- 基本情報 -->
        <div class="border-b pb-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">基本情報</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="projectName" class="block text-sm font-medium text-gray-600 mb-1">作品名</label>
                    <input type="text" id="projectName" placeholder="例: ○○プロジェクト" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="cvName" class="block text-sm font-medium text-gray-600 mb-1">CV名</label>
                    <input type="text" id="cvName" placeholder="例: 声優 太郎" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- 報酬計算項目 -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700 mb-4">報酬計算</h2>
            <!-- 文字数報酬 -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <p class="font-medium text-gray-800 mb-2">文字数報酬</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fileInput" class="block text-sm font-medium text-gray-600 mb-1">原稿ファイル</label>
                        <input type="file" id="fileInput" accept=".txt,.docx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="charUnitPrice" class="block text-sm font-medium text-gray-600 mb-1">文字単価 (円)</label>
                        <input type="number" id="charUnitPrice" placeholder="例: 10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <p class="font-medium text-gray-800 mb-2">PR原稿用 文字数報酬 (任意)</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fileInputPR" class="block text-sm font-medium text-gray-600 mb-1">PR用原稿ファイル</label>
                        <input type="file" id="fileInputPR" accept=".txt,.docx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="charUnitPricePR" class="block text-sm font-medium text-gray-600 mb-1">PR用文字単価 (円)</label>
                        <input type="number" id="charUnitPricePR" placeholder="例: 8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- オプション項目 -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="font-medium text-gray-800 mb-2">オプション項目 (任意入力)</p>
                <div class="grid grid-cols-3 gap-4 mb-3">
                    <label class="col-span-3 sm:col-span-1 flex items-center text-sm font-medium text-gray-600">時間指定</label>
                    <input type="number" id="timeSeconds" placeholder="秒数 (例: 60)" class="col-span-3 sm:col-span-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="number" id="timeUnitPrice" placeholder="単価 (円/秒)" class="col-span-3 sm:col-span-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-3 gap-4 mb-3">
                    <label class="col-span-3 sm:col-span-1 flex items-center text-sm font-medium text-gray-600">アドリブ</label>
                    <input type="number" id="adlibSeconds" placeholder="秒数 (例: 30)" class="col-span-3 sm:col-span-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="number" id="adlibUnitPrice" placeholder="単価 (円/秒)" class="col-span-3 sm:col-span-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-3 gap-4 mb-3">
                    <label for="transportationCost" class="col-span-3 sm:col-span-1 flex items-center text-sm font-medium text-gray-600">交通費</label>
                    <input type="number" id="transportationCost" placeholder="金額 (円)" class="col-span-3 sm:col-span-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <label for="otherCost" class="col-span-3 sm:col-span-1 flex items-center text-sm font-medium text-gray-600">その他</label>
                    <input type="number" id="otherCost" placeholder="金額 (円)" class="col-span-3 sm:col-span-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- ★追加: 税金関連 -->
                <div class="mt-4 pt-4 border-t border-gray-200 flex items-center space-x-6">
                     <label class="flex items-center text-sm font-medium text-gray-600">
                        <input type="checkbox" id="consumptionTaxCheck" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                        消費税 (10%)
                    </label>
                    <label class="flex items-center text-sm font-medium text-gray-600">
                        <input type="checkbox" id="withholdingTaxCheck" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                        源泉徴収 (10.21%)
                    </label>
                </div>
            </div>
        </div>

        <!-- 計算ボタン -->
        <button id="calculateButton" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">計算する</button>

        <!-- 計算結果 -->
        <div id="result" class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">報酬明細</h2>
            <div class="space-y-2 text-gray-700">
                <div class="flex justify-between items-center">
                    <span>文字数報酬 <span id="charCountDisplay" class="text-sm text-gray-500 ml-1"></span></span>
                    <span id="charPrice" class="font-semibold">0 円</span>
                </div>
                 <div class="flex justify-between items-center">
                    <span>PR原稿 文字数報酬 <span id="prCharCountDisplay" class="text-sm text-gray-500 ml-1"></span></span>
                    <span id="prCharPrice" class="font-semibold">0 円</span>
                </div>
                <div class="flex justify-between"><span>時間指定報酬</span><span id="timePrice" class="font-semibold">0 円</span></div>
                <div class="flex justify-between"><span>アドリブ報酬</span><span id="adlibPrice" class="font-semibold">0 円</span></div>
                <div class="flex justify-between"><span>その他</span><span id="otherPrice" class="font-semibold">0 円</span></div>
                <div class="flex justify-between font-medium pt-2 border-t mt-2"><span>小計</span><span id="subtotalPrice" class="font-semibold">0 円</span></div>
                <div class="flex justify-between"><span>消費税 (10%)</span><span id="consumptionTaxPrice" class="font-semibold">0 円</span></div>
                <div class="flex justify-between"><span>交通費</span><span id="transportationPrice" class="font-semibold">0 円</span></div>
                <div class="flex justify-between text-red-600"><span>源泉徴収税 (-10.21%)</span><span id="withholdingTaxPrice" class="font-semibold">0 円</span></div>
            </div>
            <div class="flex justify-between text-xl font-bold text-gray-800 mt-4 pt-4 border-t">
                <span>支払合計額 (手取り)</span>
                <span id="totalPrice" class="text-blue-600">0 円</span>
            </div>
            <button id="exportButton" class="mt-6 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300">Excelで出力</button>
        </div>
        
        <div id="messageBox" class="fixed top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-md hidden" role="alert">
            <strong class="font-bold">エラー: </strong>
            <span class="block sm:inline" id="messageText"></span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const allInputs = {
                projectName: document.getElementById('projectName'),
                cvName: document.getElementById('cvName'),
                fileInput: document.getElementById('fileInput'),
                charUnitPrice: document.getElementById('charUnitPrice'),
                fileInputPR: document.getElementById('fileInputPR'),
                charUnitPricePR: document.getElementById('charUnitPricePR'),
                timeSeconds: document.getElementById('timeSeconds'),
                timeUnitPrice: document.getElementById('timeUnitPrice'),
                adlibSeconds: document.getElementById('adlibSeconds'),
                adlibUnitPrice: document.getElementById('adlibUnitPrice'),
                transportationCost: document.getElementById('transportationCost'),
                otherCost: document.getElementById('otherCost'),
                consumptionTaxCheck: document.getElementById('consumptionTaxCheck'),
                withholdingTaxCheck: document.getElementById('withholdingTaxCheck'),
            };
            const calculateButton = document.getElementById('calculateButton');
            const exportButton = document.getElementById('exportButton');
            const resultDiv = document.getElementById('result');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');

            const resultSpans = {
                charCountDisplay: document.getElementById('charCountDisplay'),
                charPrice: document.getElementById('charPrice'),
                prCharCountDisplay: document.getElementById('prCharCountDisplay'),
                prCharPrice: document.getElementById('prCharPrice'),
                timePrice: document.getElementById('timePrice'),
                adlibPrice: document.getElementById('adlibPrice'),
                otherPrice: document.getElementById('otherPrice'),
                subtotalPrice: document.getElementById('subtotalPrice'),
                consumptionTaxPrice: document.getElementById('consumptionTaxPrice'),
                transportationPrice: document.getElementById('transportationPrice'),
                withholdingTaxPrice: document.getElementById('withholdingTaxPrice'),
                totalPrice: document.getElementById('totalPrice'),
            };
            
            let lastCalculationResult = {};

            function showMessage(message) {
                messageText.textContent = message;
                messageBox.classList.remove('hidden');
                setTimeout(() => messageBox.classList.add('hidden'), 3000);
            }
            
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    if (!file) { resolve(""); return; }
                    const reader = new FileReader();
                    if (file.name.endsWith('.docx')) {
                        reader.onload = e => mammoth.extractRawText({ arrayBuffer: e.target.result })
                            .then(result => resolve(result.value))
                            .catch(err => reject(new Error('Wordファイルの解析に失敗しました。')));
                        reader.readAsArrayBuffer(file);
                    } else if (file.name.endsWith('.txt')) {
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = () => reject(new Error('テキストファイルの読み込みに失敗しました。'));
                        reader.readAsText(file, 'UTF-8');
                    } else {
                        reject(new Error('対応ファイルは .txt と .docx のみです。'));
                    }
                });
            }

            function calculateAndDisplay(texts, inputs) {
                const [mainText, prText] = texts;

                const charCount = mainText.replace(/[\s　]/g, '').length;
                const charPrice = charCount * inputs.charUnitPrice;

                const prCharCount = prText.replace(/[\s　]/g, '').length;
                const prCharPrice = prCharCount * inputs.charUnitPricePR;

                const timePrice = inputs.timeSeconds * inputs.timeUnitPrice;
                const adlibPrice = inputs.adlibSeconds * inputs.adlibUnitPrice;
                const otherPrice = inputs.otherCost;
                const transportationPrice = inputs.transportationCost;

                const subtotal = charPrice + prCharPrice + timePrice + adlibPrice + otherPrice;
                const consumptionTax = inputs.applyConsumptionTax ? Math.floor(subtotal * 0.1) : 0;
                const withholdingBase = subtotal + consumptionTax;
                const withholdingTax = inputs.applyWithholdingTax ? Math.floor(withholdingBase * 0.1021) : 0;
                
                const totalPrice = subtotal + consumptionTax + transportationPrice - withholdingTax;

                // 結果表示
                resultSpans.charCountDisplay.textContent = `(${charCount.toLocaleString()} 文字)`;
                resultSpans.charPrice.textContent = `${charPrice.toLocaleString()} 円`;
                resultSpans.prCharCountDisplay.textContent = prCharCount > 0 ? `(${prCharCount.toLocaleString()} 文字)` : '';
                resultSpans.prCharPrice.textContent = `${prCharPrice.toLocaleString()} 円`;
                resultSpans.timePrice.textContent = `${timePrice.toLocaleString()} 円`;
                resultSpans.adlibPrice.textContent = `${adlibPrice.toLocaleString()} 円`;
                resultSpans.otherPrice.textContent = `${otherPrice.toLocaleString()} 円`;
                resultSpans.subtotalPrice.textContent = `${subtotal.toLocaleString()} 円`;
                resultSpans.consumptionTaxPrice.textContent = `${consumptionTax.toLocaleString()} 円`;
                resultSpans.transportationPrice.textContent = `${transportationPrice.toLocaleString()} 円`;
                resultSpans.withholdingTaxPrice.textContent = `-${withholdingTax.toLocaleString()} 円`;
                resultSpans.totalPrice.textContent = `${totalPrice.toLocaleString()} 円`;
                resultDiv.classList.remove('hidden');
                
                // Excel出力用に結果を保存
                lastCalculationResult = {
                    projectName: inputs.projectName,
                    cvName: inputs.cvName,
                    details: [
                        { item: '文字数報酬', count: `${charCount.toLocaleString()} 文字`, unitPrice: `${inputs.charUnitPrice.toLocaleString()} 円`, price: charPrice },
                        { item: 'PR原稿 文字数報酬', count: `${prCharCount.toLocaleString()} 文字`, unitPrice: `${inputs.charUnitPricePR.toLocaleString()} 円`, price: prCharPrice },
                        { item: '時間指定報酬', count: `${inputs.timeSeconds.toLocaleString()} 秒`, unitPrice: `${inputs.timeUnitPrice.toLocaleString()} 円/秒`, price: timePrice },
                        { item: 'アドリブ報酬', count: `${inputs.adlibSeconds.toLocaleString()} 秒`, unitPrice: `${inputs.adlibUnitPrice.toLocaleString()} 円/秒`, price: adlibPrice },
                        { item: 'その他', count: '', unitPrice: '', price: otherPrice },
                    ],
                    subtotal, consumptionTax, transportationPrice, withholdingTax, totalPrice
                };
            }

            calculateButton.addEventListener('click', async () => {
                const mainFile = allInputs.fileInput.files[0];
                const prFile = allInputs.fileInputPR.files[0];
                
                const getNumericValue = (element) => parseFloat(element.value) || 0;

                const inputs = {
                    projectName: allInputs.projectName.value,
                    cvName: allInputs.cvName.value,
                    charUnitPrice: getNumericValue(allInputs.charUnitPrice),
                    charUnitPricePR: getNumericValue(allInputs.charUnitPricePR),
                    timeSeconds: getNumericValue(allInputs.timeSeconds),
                    timeUnitPrice: getNumericValue(allInputs.timeUnitPrice),
                    adlibSeconds: getNumericValue(allInputs.adlibSeconds),
                    adlibUnitPrice: getNumericValue(allInputs.adlibUnitPrice),
                    transportationCost: getNumericValue(allInputs.transportationCost),
                    otherCost: getNumericValue(allInputs.otherCost),
                    applyConsumptionTax: allInputs.consumptionTaxCheck.checked,
                    applyWithholdingTax: allInputs.withholdingTaxCheck.checked,
                };

                if (!mainFile || inputs.charUnitPrice <= 0) {
                    showMessage('原稿ファイルと有効な文字単価は必須です。');
                    return;
                }

                try {
                    calculateButton.disabled = true;
                    calculateButton.textContent = "計算中...";
                    const texts = await Promise.all([readFileAsText(mainFile), readFileAsText(prFile)]);
                    calculateAndDisplay(texts, inputs);
                } catch (error) {
                    showMessage(error.message);
                } finally {
                    calculateButton.disabled = false;
                    calculateButton.textContent = "計算する";
                }
            });

            exportButton.addEventListener('click', () => {
                const { projectName, cvName, details, subtotal, consumptionTax, transportationPrice, withholdingTax, totalPrice } = lastCalculationResult;
                if (!projectName || !cvName) {
                    showMessage('Excel出力には作品名とCV名の入力が必要です。');
                    return;
                }
                
                const filteredDetails = details.filter(d => d.price > 0);

                const ws_data = [
                    ["作品名", projectName],
                    ["CV名", cvName],
                    [],
                    ["報酬明細"],
                    ["項目", "数量", "単価", "金額 (円)"],
                    ...filteredDetails.map(d => [d.item, d.count, d.unitPrice, d.price]),
                    [],
                    ["", "", "小計", subtotal],
                    ["", "", "消費税 (10%)", consumptionTax],
                    ["", "", "源泉徴収税 (10.21%)", -withholdingTax],
                    ["", "", "交通費", transportationPrice],
                    ["", "", "支払合計額 (手取り)", totalPrice]
                ];

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                
                ws['!cols'] = [{wch:25}, {wch:15}, {wch:15}, {wch:15}];
                XLSX.utils.book_append_sheet(wb, ws, "報酬明細");
                const fileName = `報酬明細_${projectName}_${cvName}.xlsx`;
                XLSX.writeFile(wb, fileName);
            });
        });
    </script>
</body>
</html>
